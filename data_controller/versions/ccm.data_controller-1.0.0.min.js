(()=>{const e={name:"data_controller",version:[1,0,0],ccm:"https://ccmjs.github.io/ccm/versions/ccm-25.5.3.min.js",config:{helper:["ccm.load","https://ccmjs.github.io/akless-components/modules/versions/helper-5.1.0.mjs"],hash:["ccm.load","https://ccmjs.github.io/akless-components/modules/md5.mjs"],domains_websites_mapping:["ccm.store",{name:"fbroeh2s_domains_websites_mapping",url:"https://ccm2.inf.h-brs.de"}],websites:["ccm.store",{name:"fbroeh2s_websites",url:"https://ccm2.inf.h-brs.de"}],users:["ccm.store",{name:"fbroeh2s_users",url:"https://ccm2.inf.h-brs.de"}]},Instance:function(){let e;this.ready=(async()=>{e=Object.assign({},this.ccm.helper,this.helper)}),this.start=(async()=>{}),this.getWebsiteUsersDataStore=(async e=>{return await this.ccm.store({name:"fbroeh2s_website_"+e+"_users",url:"https://ccm2.inf.h-brs.de",parent:this})}),this.getUserWebsitesDataStore=(async e=>{return await this.ccm.store({name:"fbroeh2s_user_"+this.hash.md5(e)+"_websites",url:"https://ccm2.inf.h-brs.de",parent:this})}),this.getWebsiteThemesDataStore=(async e=>{return await this.ccm.store({name:"fbroeh2s_website_"+e+"_themes",url:"https://ccm2.inf.h-brs.de",parent:this})}),this.getWebsiteThemeDefinitionsDataStore=(async(e,t)=>{return await this.ccm.store({name:"fbroeh2s_website_"+e+"_theme_"+t+"_definitions",url:"https://ccm2.inf.h-brs.de",parent:this})}),this.getWebsitePagesDataStore=(async e=>{return await this.ccm.store({name:"fbroeh2s_website_"+e+"_pages",url:"https://ccm2.inf.h-brs.de",parent:this})}),this.getWebsitePageChildrenDataStore=(async(e,t)=>{return await this.ccm.store({name:"fbroeh2s_website_"+e+"_page_"+t+"_children",url:"https://ccm2.inf.h-brs.de",parent:this})}),this.getWebsitePageUrlMappingDataStore=(async(e,t=!1)=>{return await this.ccm.store({name:"fbroeh2s_website_"+e+"_pages_url_mapping"+(t?"_live":""),url:"https://ccm2.inf.h-brs.de",parent:this})}),this.getWebsiteAppsDataStore=(async e=>{return await this.ccm.store({name:"fbroeh2s_website_"+e+"_apps",url:"https://ccm2.inf.h-brs.de",parent:this})}),this.getUserLocalDataStore=(async e=>{return await this.ccm.store({name:"localDb_"+this.hash.md5(e),parent:this})}),this.getWebsite=(async e=>{let t=await this.websites.get(e);if(null!=t){let s=t.value;return s.websiteKey=e,s}return null}),this.getWebsiteFromDomain=(async e=>{let t=await this.domains_websites_mapping.get(this.hash.md5(e));if(null!=t){return this.getWebsite(t.value)}return null}),this.getWebsitePermissions=(async(e=!1)=>{let t=[];if(0!=e){t=await this.getWebsiteAdminUsernames(e)}const s=await this.getCurrentWorkingUsername();return t.indexOf(s)<0&&t.push(s),{creator:s,realm:"modularcms",group:t,access:{get:"all",set:"group",del:"group"}}}),this.createWebsite=((e,t)=>new Promise(async(s,a)=>{const i=await this.getCurrentWorkingUsername();if(null==await this.domains_websites_mapping.get(this.hash.md5(e))){const a=await this.websites.set({value:{domain:e,baseUrl:t},_:await this.getWebsitePermissions()});await this.domains_websites_mapping.set({key:this.hash.md5(e),value:a,_:await this.getWebsitePermissions()}),await this.addUserToWebsite(a,i,"admin");const r=await this.ccm.load({url:"https://modularcms.github.io/modularcms-cabrare-theme/theme.json",method:"GET"}),n=(e,t=null)=>new Promise((s,a)=>{if(null!=t&&e.type!==t||void 0===e.name||"string"!=typeof e.name||void 0===e.ccmComponent||"object"!=typeof e.ccmComponent||void 0===e.ccmComponent.url||"string"!=typeof e.ccmComponent.url||void 0===e.ccmComponent.config||"object"!=typeof e.ccmComponent.config||void 0===e.custom)a();else{let t={name:e.name,ccmComponent:e.ccmComponent,custom:e.custom};"theme"!=e.type&&(t.type=e.type),s(t)}}),o=await n(r,"theme"),h=await this.createTheme(a,o);let l=null,c=null;for(let e of r.themeDefinitions){const t=await n(e),s=await this.createThemeDefinition(a,h,t);"Plain"==t.name&&(l=s),"Row with columns"==t.name&&(c=s)}const g={parentKey:null,title:"Hello world!",urlPart:"/",meta:{description:"",keywords:"",robots:!0},themeKey:h,themeConfig:{},contentZones:{layout:[{type:"themeDefinition",data:{themeDefinitionType:"layout",themeDefinitionKey:l,config:{}},contentZones:{main:[{type:"themeDefinition",data:{themeDefinitionType:"block",themeDefinitionKey:c,config:{}},contentZones:{column1:[{type:"header",data:{text:"Hello world!",level:1},contentZones:{}},{type:"paragraph",data:{text:"This is a new website made with <b>modularcms</b>."},contentZones:{}}]}}]}}]},changeLog:[]},m=await this.createPage(a,g);await this.publishPage(a,m,"Initial start page commit"),s(a)}else a()})),this.setWebsiteObject=((e,t)=>new Promise(async(s,a)=>{let i=await this.getWebsite(e);if(i.domain!=t.domain){if(null!=await this.domains_websites_mapping.get(this.hash.md5(t.domain)))return void a()}void 0!==t.websiteKey&&delete t.websiteKey,await this.websites.set({key:e,value:t,_:await this.getWebsitePermissions(e)}),i.domain!=t.domain&&(await this.domains_websites_mapping.del(this.hash.md5(i.domain)),await this.domains_websites_mapping.set({key:this.hash.md5(t.domain),value:e,_:await this.getWebsitePermissions()})),s()})),this.getWebsiteUsers=(async e=>{const t=await this.getWebsiteUsersDataStore(e),s=await t.get();let a=[];for(let e of s){let t=e.value;a.push(t)}return a}),this.getWebsiteUser=(async(e,t)=>{const s=await this.getWebsiteUsersDataStore(e);return(await s.get(this.hash.md5(t))).value}),this.getWebsiteMemberUsernames=(async e=>{const t=await this.getWebsiteUsers(e);let s=[];for(let e of t)s.push(e.username);return s}),this.getWebsiteAuthorUsernames=(async e=>{const t=await this.getWebsiteUsers(e);let s=[];const a=["author","editor","admin"];for(let e of t)a.indexOf(e.role)>=0&&s.push(e.username);return s}),this.getWebsiteEditorUsernames=(async e=>{const t=await this.getWebsiteUsers(e);let s=[];const a=["editor","admin"];for(let e of t)a.indexOf(e.role)>=0&&s.push(e.username);return s}),this.getWebsiteAdminUsernames=(async e=>{const t=await this.getWebsiteUsers(e);let s=[];for(let e of t)"admin"==e.role&&s.push(e.username);return s}),this.removeWebsite=(async e=>{let t=await this.getWebsite(e);await this.websites.del(e),await this.domains_websites_mapping.del(this.hash.md5(t.domain));const s=await this.getWebsiteUsersDataStore(e),a=await s.get();for(let t of a){s.del(t.key),(await this.getUserWebsitesDataStore(t.value.username)).del(e)}}),this.getUserFromUsername=(async e=>{let t=await this.users.get(this.hash.md5(e));if(null!=t){return t.value}return null}),this.getUserPermissions=(async()=>{return{creator:await this.getCurrentWorkingUsername(),realm:"modularcms",access:{get:"all",set:"creator",del:"creator"}}}),this.createUser=(e=>new Promise(async(t,s)=>{null==await this.users.get(this.hash.md5(e))?(await this.users.set({key:this.hash.md5(e),value:{username:e,image:null},_:await this.getUserPermissions()}),t()):s()})),this.getUserWebsites=(async e=>{const t=await this.getUserWebsitesDataStore(e),s=await t.get();let a=[];for(let e of s)a.push(new Promise(async(t,s)=>{let a=await this.getWebsite(e.key);a.role=e.value.role,t(a)}));return await Promise.all(a)}),this.getUserAdminWebsites=(async e=>{return(await this.getUserWebsites(e)).filter(e=>"admin"==e.role)}),this.getUserWebsiteRole=(async(e,t)=>{const s=await this.getUserWebsitesDataStore(e),a=await s.get(t);return null!=a?a.value.role:null}),this.setUserObject=(async(e,t)=>{t.username=e,await this.users.set({key:this.hash.md5(e),value:t,_:await this.getUserPermissions()})}),this.removeUser=(async e=>{await this.users.del(this.hash.md5(e));const t=await this.getUserWebsitesDataStore(e),s=t.get();for(let a of s){t.del(a.key),(await this.getWebsiteUsersDataStore(a.key)).del(this.hash.md5(e))}}),this.getUserWebsiteMappingPermissions=(async e=>{let t=await this.getWebsiteAdminUsernames(e),s=t;const a=await this.getCurrentWorkingUsername();return t.indexOf(a)<0&&s.push(a),{creator:a,realm:"modularcms",group:s,access:{get:"all",set:"group",del:"group"}}}),this.addUserToWebsite=(async(e,t,s)=>new Promise(async(a,i)=>{if(null!=await this.getUserFromUsername(t)){(await this.getUserWebsitesDataStore(t)).set({key:e,value:{username:t,role:s},_:await this.getUserWebsiteMappingPermissions(e)}),(await this.getWebsiteUsersDataStore(e)).set({key:this.hash.md5(t),value:{username:t,role:s},_:await this.getUserWebsiteMappingPermissions(e)}),await this.updateUserPermissions(e),a()}else i()})),this.removeUserFromWebsite=(async(e,t)=>{(await this.getUserWebsitesDataStore(t)).del(e),(await this.getWebsiteUsersDataStore(e)).del(this.hash.md5(t)),await this.updateUserPermissions(e)}),this.updateUserPermissions=(async e=>{const t=await this.getWebsite(e);await this.setWebsiteObject(e,t);const s=await this.getAllThemesOfWebsite(e);for(let t of s){await this.setThemeObject(e,t.themeKey,t);const s=await this.getAllThemeDefinitionsOfTheme(e,t.themeKey);for(let a of s)await this.setThemeDefinitionObject(e,t.themeKey,a.themeDefinitionKey,layout)}const a=await this.getAllPagesOfWebsite(e);for(let t of a.filter(e=>!/_live$/.test(e.pageKey))){let s={};Object.assign(s,t),delete s.pageKey,await this.setPageObject(e,t.pageKey,s,!1);const a=await this.getFullPageUrl(e,t.pageKey);if(null!=a){const t=await this.getWebsitePageUrlMappingDataStore(e),s=await t.get(this.hash.md5(a));s._=await this.getPagePermissions(e),await t.set(s)}}for(let t of a.filter(e=>/_live$/.test(e.pageKey))){const s=await this.getWebsitePagesDataStore(e);let a={};Object.assign(a,t),delete a.pageKey,await s.set({key:t.pageKey,value:a,_:await this.getPagePublishPermissions(e)});const i=await this.getFullPageUrl(e,t.pageKey);if(null!=i){const t=await this.getWebsitePageUrlMappingDataStore(e,!0),s=await t.get(this.hash.md5(i));s._=await this.getPagePublishPermissions(e),await t.set(s)}}}),this.setUserPermission=(async(e,t,s)=>{await this.addUserToWebsite(e,t,s)}),this.getTheme=(async(e,t)=>{const s=await this.getWebsiteThemesDataStore(e);let a=await s.get(t),i=a.value;return i.themeKey=a.key,i}),this.getAllThemesOfWebsite=(async e=>{const t=await this.getWebsiteThemesDataStore(e);let s=await t.get(),a=[];for(let e of s){let t=e.value;t.themeKey=e.key,a.push(t)}return a}),this.getThemePermissions=(async(e=!1)=>{let t=[];if(0!=e){t=await this.getWebsiteAdminUsernames(e)}const s=await this.getCurrentWorkingUsername();return t.indexOf(s)<0&&t.push(s),{creator:s,realm:"modularcms",group:t,access:{get:"all",set:"group",del:"group"}}}),this.createTheme=(async(e,t)=>{const s=await this.getWebsiteThemesDataStore(e);return await s.set({value:t,_:await this.getThemePermissions(e)})}),this.setThemeObject=(async(e,t,s)=>{const a=await this.getWebsiteThemesDataStore(e);void 0!==s.themeKey&&delete s.themeKey,await a.set({key:t,value:s,_:await this.getThemePermissions(e)})}),this.removeTheme=(async(e,t)=>{const s=await this.getWebsiteThemesDataStore(e);await s.del(t)}),this.getThemeDefinition=(async(e,t,s)=>{const a=await this.getWebsiteThemeDefinitionsDataStore(e,t);let i=await a.get(s);if(null!=i){let e=i.value;return e.themeDefinitionKey=i.key,e}return null}),this.getAllThemeDefinitionsOfTheme=(async(e,t)=>{const s=await this.getWebsiteThemeDefinitionsDataStore(e,t);let a=await s.get(),i=[];for(let e of a){let t=e.value;t.themeDefinitionKey=e.key,i.push(t)}return i}),this.getThemeDefinitionPermissions=(async(e=!1)=>{let t=[];if(0!=e){t=await this.getWebsiteAdminUsernames(e)}const s=await this.getCurrentWorkingUsername();return t.indexOf(s)<0&&t.push(s),{creator:s,realm:"modularcms",group:t,access:{get:"all",set:"group",del:"group"}}}),this.createThemeDefinition=(async(e,t,s)=>{const a=await this.getWebsiteThemeDefinitionsDataStore(e,t);return await a.set({value:s,_:await this.getThemeDefinitionPermissions(e)})}),this.setThemeDefinitionObject=(async(e,t,s,a)=>{const i=await this.getWebsiteThemeDefinitionsDataStore(e,t);void 0!==a.themeDefinitionKey&&delete a.themeDefinitionKey,await i.set({key:s,value:a,_:await this.getThemeDefinitionPermissions(e)})}),this.removeThemeDefinition=(async(e,t,s)=>{const a=await this.getWebsiteThemeDefinitionsDataStore(e,t);await a.del(s)}),this.getPage=(async(e,t)=>{const s=await this.getWebsitePagesDataStore(e),a=await s.get(t);if(null!=a){let e=a.value;return e.pageKey=a.key,e._=a._,e.updated_at=a.updated_at,e.created_at=a.created_at,e}return null}),this.getPageByUrl=(async(e,t,s=!1)=>{const a=await this.getWebsitePageUrlMappingDataStore(e,s),i=await a.get(this.hash.md5(t));if(null!=i){const t=i.value;return this.getPage(e,t)}return null}),this.getFullPageUrl=(async(e,t)=>{await this.getWebsitePagesDataStore(e);let s="",a=t;do{let t=await this.getPage(e,a);if(null==t)return null;s=("/"==t.urlPart?"":t.urlPart)+s,a=t.parentKey}while(null!=a);return""==s?"/":s}),this.getPageChildren=(async(e,t)=>{const s=await this.getWebsitePageChildrenDataStore(e,t);let a=await s.get(),i=[];for(let t of a)i.push(this.getPage(e,t.key));return await Promise.all(i)}),this.getAllPagesOfWebsite=(async e=>{const t=await this.getWebsitePagesDataStore(e);let s=await t.get(),a=[];for(let e of s){let t=e.value;t.pageKey=e.key,a.push(t)}return a}),this.getPagePermissions=(async(e=!1)=>{let t=[];if(0!=e){t=await this.getWebsiteEditorUsernames(e)}const s=await this.getCurrentWorkingUsername();t.indexOf(s)<0&&t.push(s);let a=[];if(0!=e){a=await this.getWebsiteMemberUsernames(e)}return{creator:s,realm:"modularcms",group:{editUserGroup:t,getUserGroup:a},access:{get:"getUserGroup",set:"editUserGroup",del:"editUserGroup"}}}),this.getPagePublishPermissions=(async(e=!1)=>{let t=[];if(0!=e){t=await this.getWebsiteEditorUsernames(e)}const s=await this.getCurrentWorkingUsername();return t.indexOf(s)<0&&t.push(s),{creator:s,realm:"modularcms",group:t,access:{get:"all",set:"group",del:"group"}}}),this.createPage=(async(e,t)=>new Promise(async(s,a)=>{const i=await this.getWebsitePageUrlMappingDataStore(e);let r="/";if(null!=t.parentKey){const s=await this.getFullPageUrl(e,t.parentKey);r=("/"==s?"":s)+t.urlPart}if(null==await i.get(this.hash.md5(r))){const a=await this.getWebsitePagesDataStore(e);let n=await a.set({value:t,_:await this.getPagePermissions(e)});if(void 0!==t.parentKey&&null!=t.parentKey){const s=await this.getWebsitePageChildrenDataStore(e,t.parentKey);await s.set({key:n,value:null,_:await this.getPagePermissions(e)})}await i.set({key:this.hash.md5(r),value:n,_:await this.getPagePermissions(e)}),s(n)}else a()})),this.setPageObject=((e,t,s,a=!1)=>new Promise(async(i,r)=>{const n=await this.getCurrentWorkingUsername(),o=await this.getWebsiteUser(e,n),h=await this.getPage(e,t),l=await this.getFullPageUrl(e,t);if("member"!=o.role||"member"==o.role&&h._.creator==n){const o=await this.getWebsitePageUrlMappingDataStore(e);let c="/";if(null!=s.parentKey){const t=await this.getFullPageUrl(e,s.parentKey);c=("/"==t?"":t)+s.urlPart}if(c!=l){if(null!=await o.get(this.hash.md5(c)))return void r("Specified page url is already existing")}void 0!==s.pageKey&&delete s.pageKey,void 0!==s._&&delete s._,void 0!==s.updated_at&&delete s.updated_at,void 0!==s.created_at&&delete s.created_at,!1!==a&&(void 0===s.changeLog&&(s.changeLog=[]),s.changeLog.push({timestamp:(new Date).getTime(),username:n,commitMessage:a,publish:!1}));const g=await this.getWebsitePagesDataStore(e);await g.set({key:t,value:s,_:await this.getPagePermissions(e)});const m=await this.getWebsitePageChildrenDataStore(e,h.parentKey);void 0!==h.parentKey&&await m.del(t),void 0!==s.parentKey&&await m.set({key:t,value:null,_:await this.getPagePermissions(e)}),l!=c&&await o.del(this.hash.md5(l)),await o.set({key:this.hash.md5(c),value:t,_:await this.getPagePermissions(e)}),i()}else r("You're not allowed to save this page")})),this.publishPage=((e,t,s=!1)=>new Promise(async(a,i)=>{const r=await this.getCurrentWorkingUsername(),n=await this.getWebsiteUser(e,r),o=this.getPage(e,t+"_live"),h=await this.getFullPageUrl(e,t+"_live"),l=await this.getWebsitePagesDataStore(e);let c=await this.getPage(e,t);if("member"!=n.role&&"author"!=n.role||"author"==n.role&&c._.creator==r){if(c.parentKey&&(c.parentKey+="_live"),c.parentKey){if(!await this.getPage(e,c.parentKey))return void i("The page can only be published if the parent page was published")}!1!==s&&(void 0===c.changeLog&&(c.changeLog=[]),c.changeLog.push({timestamp:(new Date).getTime(),username:r,commitMessage:s,publish:!0})),await l.set({key:t+"_live",value:c,_:await this.getPagePublishPermissions(e)});const n=await this.getWebsitePageChildrenDataStore(e,o.parentKey);if(null!=o&&o.parentKey&&await n.del(o.parentKey),c.parentKey){const s=await this.getWebsitePageChildrenDataStore(e,c.parentKey);await s.set({key:t+"_live",value:null,_:await this.getPagePublishPermissions(e)})}const g=await this.getWebsitePageUrlMappingDataStore(e,!0),m=await this.getFullPageUrl(e,t);h!=m&&await g.del(this.hash.md5(h)),await g.set({key:this.hash.md5(m),value:t+"_live",_:await this.getPagePublishPermissions(e)}),a()}else i("You're not allowed to publish this page")})),this.removePage=(async(e,t)=>{const s=await this.getPage(e,t),a=await this.getFullPageUrl(e,t),i=await this.getWebsitePagesDataStore(e);if(await i.del(t),await i.del(t+"_live"),void 0!==s.parentKey&&null!=s.parentKey){const a=await this.getWebsitePageChildrenDataStore(e,s.parentKey);await a.del(t)}const r=await this.getWebsitePageUrlMappingDataStore(e),n=await this.getWebsitePageUrlMappingDataStore(e,!0);await Promise.all([r.del(this.hash.md5(a)),n.del(this.hash.md5(a))])}),this.isPagePublishedVersionEqual=(async(e,t)=>{const s=await this.getPage(e,t);null!=s&&(void 0!==s.changeLog&&delete s.changeLog,void 0!==s._&&delete s._,void 0!==s.pageKey&&delete s.pageKey);const a=null==s||this.hash.md5(JSON.stringify(s)),i=await this.getPage(e,t+"_live");return null!=i&&(void 0!==i.changeLog&&delete i.changeLog,void 0!==i._&&delete i._,void 0!==i.pageKey&&delete i.pageKey,null!=i.parentKey&&(i.parentKey=i.parentKey.replace("_live",""))),a==(null==i||this.hash.md5(JSON.stringify(i)))}),this.createWebsiteAppFromDemo=(async(t,s,a,i)=>{let r=await e.dataset(await e.action(a[2]));return await this.createWebsiteApp(t,s,r,i)}),this.createWebsiteAppEmpty=(async(t,s,a)=>{let i=await e.dataset({});return await this.createWebsiteApp(t,s,i,a)}),this.createWebsiteApp=(async(e,t,s,a)=>{console.log(e,t,s,a);let i=await this.getWebsiteAppsDataStore(e);delete s.key,s.meta=a,s._={access:{get:"all",set:"creator",del:"creator"}};let r=await i.set(s);return delete s.key,["ccm.get",{url:"https://ccm2.inf.h-brs.de",name:"fbroeh2s_website_"+e+"_apps"},r]}),this.getWebsiteApp=(async(e,t)=>{let s=await this.getWebsiteAppsDataStore(e);return await s.get(t)}),this.getSelectedWebsiteKey=(async()=>{const e=await this.getCurrentWorkingUsername(),t=await this.getUserLocalDataStore(e);let s=await t.get("selectedWebsite");if(null!=s)return s.value;let a=await this.getUserWebsites(e);return a.length>=1?a[0].websiteKey:null}),this.setSelectedWebsiteKey=(async e=>{const t=await this.getCurrentWorkingUsername(),s=await this.getUserLocalDataStore(t);await s.set({key:"selectedWebsite",value:e})}),this.removeSelectedWebsiteKey=(async()=>{const e=await this.getCurrentWorkingUsername(),t=await this.getUserLocalDataStore(e);await t.del("selectedWebsite")}),this.getCurrentWorkingUsername=(async()=>{let e=sessionStorage.getItem("ccm-user-modularcms");return null!=e?JSON.parse(e).user:null})}};let t="ccm."+e.name+(e.version?"-"+e.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[t])return window.ccm.files[t]=e;(t=window.ccm&&window.ccm.components[e.name])&&t.ccm&&(e.ccm=t.ccm),"string"==typeof e.ccm&&(e.ccm={url:e.ccm});let s=(e.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[s])window.ccm[s].component(e);else{var a=document.createElement("script");document.head.appendChild(a),e.ccm.integrity&&a.setAttribute("integrity",e.ccm.integrity),e.ccm.crossorigin&&a.setAttribute("crossorigin",e.ccm.crossorigin),a.onload=function(){window.ccm[s].component(e),document.head.removeChild(a)},a.src=e.ccm.url}})();